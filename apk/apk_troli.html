<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-green': '#10B981', 
                        'custom-red': '#EF4444',  
                        'custom-green-dark': '#16A34A', 
                        'custom-yellow': '#FBBF24',
                    }
                }
            }
        }
    </script>
    <style>
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-white min-h-screen">

    <div class="max-w-6xl mx-auto p-4 pt-8 h-screen flex flex-col">
        
        <header class="flex justify-between items-center mb-6">
            <button onclick="window.location.href='apk_market.html'" class="text-custom-green text-3xl font-bold rounded-full p-1 hover:bg-gray-100 transition">&larr;</button>
            <div class="text-2xl font-normal text-gray-800">Troli</div> 
            <div class="w-8"></div> 
        </header>

        <div id="cart-items-list" class="flex-grow overflow-y-auto space-y-4 pb-4 flex flex-col">
            </div>
        
        <div id="total-price-container" class="py-4 border-t border-gray-200 hidden">
            <div class="flex justify-between items-center">
                <p class="text-lg font-semibold text-gray-700">Total Harga</p>
                <p id="total-price-display" class="text-2xl font-bold text-custom-green">Rp 0</p>
            </div>
        </div>

        <div class="py-4 mt-auto"> 
            <button onclick="navigateToTransaction()" id="checkout-button" class="w-full py-3 bg-custom-green-dark text-white font-bold text-lg rounded-xl hover:bg-green-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Proses
            </button>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 modal" onclick="closeDeleteConfirmModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 modal-content transform scale-95" onclick="event.stopPropagation()">
            <h4 class="font-bold text-lg text-gray-800 text-center">Hapus Item</h4>
            <p class="text-sm text-gray-600 my-4 text-center">Apakah Anda yakin ingin menghapus item ini dari troli?</p>
            <div class="flex justify-center space-x-4">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Batal</button>
                <button id="confirm-delete-button" class="flex-1 py-2 px-4 bg-custom-red text-white font-semibold rounded-lg hover:bg-red-700 transition">Ya, Hapus</button>
            </div>
        </div>
    </div>


<script>
    const CART_KEY = 'cartItems';
    const PENDING_KEY = 'pendingTransaction';
    const DB_PRODUCTS_KEY = 'gerbangPanganProducts'; // Kunci database produk yang konsisten
    
    const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

    function getCartItems() {
        return JSON.parse(localStorage.getItem(CART_KEY)) || [];
    }

    function saveCartToLocalStorage(cartItems) {
        localStorage.setItem(CART_KEY, JSON.stringify(cartItems.filter(item => item.id && item.quantity > 0)));
    }
    
    const cartItemsList = document.getElementById('cart-items-list');
    const checkoutButton = document.getElementById('checkout-button');
    const totalPriceContainer = document.getElementById('total-price-container'); 
    const totalPriceDisplay = document.getElementById('total-price-display');

    function navigateToTransaction() {
        const cartItems = getCartItems();
        if (checkoutButton.disabled) {
            alert("Troli Anda kosong atau terdapat masalah stok!");
            return;
        }

        // Ambil data pengguna yang login untuk validasi
        const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
        const customers = JSON.parse(localStorage.getItem('gerbangPanganCustomers')) || [];
        const currentUser = customers.find(c => c.email === loggedInUserEmail);
        if (!currentUser) {
            alert("Sesi Anda tidak valid. Silakan login kembali.");
            window.location.href = 'apk_login.html';
            return;
        }

        // --- PERBAIKAN FINAL: Simpan HANYA array item ke pendingTransaction ---
        // Halaman transaksi akan mengambil detail pengguna secara mandiri.
        localStorage.setItem(PENDING_KEY, JSON.stringify(cartItems));
        window.location.href = 'apk_transaksi.html';
    }
    
    function renderCartPage() {
        // PERBAIKAN: Ambil data produk terbaru dari "database" (localStorage) setiap kali render
        const masterProducts = JSON.parse(localStorage.getItem(DB_PRODUCTS_KEY)) || []; 

        const cartItems = getCartItems();
        cartItemsList.innerHTML = '';
        let grandTotal = 0; 
        let isCheckoutable = true;

        if (cartItems.length === 0) {
            cartItemsList.innerHTML = `
                <div class="text-gray-500 text-center m-auto">
                    <i data-lucide="shopping-cart" class="w-16 h-16 mx-auto text-gray-300"></i>
                    <p class="text-lg font-semibold mt-4">Troli Anda Kosong</p>
                    <p class="text-sm mt-1">Sepertinya Anda belum menambahkan produk apa pun.</p>
                    <button onclick="window.location.href='apk_market.html'" class="mt-6 bg-custom-green text-white font-bold py-2 px-6 rounded-lg hover:bg-custom-green-dark transition">
                        Mulai Belanja
                    </button>
                </div>`;
            totalPriceContainer.classList.add('hidden'); 
            checkoutButton.disabled = true;
            lucide.createIcons();
            return;
        }

        totalPriceContainer.classList.remove('hidden'); 

        cartItems.forEach(item => {
            // PERBAIKAN: Selalu cek stok terbaru dari master data
            const productInfo = masterProducts.find(p => p.id === item.id); 
            const availableStock = productInfo ? productInfo.stock : 0;
            const hasEnoughStock = item.quantity <= availableStock;
            
            if (!hasEnoughStock) isCheckoutable = false;

            const itemTotal = item.price * item.quantity;
            grandTotal += itemTotal;
            
            const itemHTML = document.createElement('div');
            // PERBAIKAN: Tambahkan class untuk menandai item dengan stok kurang
            itemHTML.className = `item-container py-3 px-2 border-b border-gray-100 last:border-b-0 ${!hasEnoughStock ? 'bg-red-50 rounded-lg' : ''}`; 
            itemHTML.innerHTML = `
                <div class="flex flex-wrap md:flex-nowrap justify-between items-center">
                    <div class="flex flex-col flex-1 w-full md:w-auto mb-2 md:mb-0">
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <div class="flex items-center space-x-2">
                            <p class="font-bold text-custom-green text-lg">${formatRupiah(item.price)}</p>
                            <p class="text-sm text-gray-500">/ ${item.unit}</p> 
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-2 ml-auto">
                        <button onclick="showDeleteConfirmModal(${item.id}, event)" class="text-xs font-semibold text-custom-red hover:text-red-600 transition">HAPUS</button>
                        <div class="flex items-center space-x-2">
                            <button onclick="changeItemQuantity(${item.id}, -1, event)" class="bg-gray-200 text-custom-green w-7 h-7 rounded-full flex items-center justify-center font-bold text-lg hover:bg-gray-300 transition ${item.quantity <= 1 ? 'opacity-50' : ''}" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <span class="text-lg font-semibold w-8 text-center">${item.quantity}</span>
                            <button onclick="changeItemQuantity(${item.id}, 1, event)" class="bg-custom-green text-white w-7 h-7 rounded-full flex items-center justify-center font-bold text-lg hover:bg-green-600 transition ${item.quantity >= availableStock ? 'opacity-50 cursor-not-allowed bg-gray-400' : ''}" ${item.quantity >= availableStock ? 'disabled' : ''}>+</button> 
                        </div>
                    </div>
                </div>
                ${!hasEnoughStock ? `<p class="text-xs text-red-600 font-medium mt-2 text-right">Stok tidak cukup! (Sisa: ${availableStock})</p>` : ''} 
            `;
            cartItemsList.appendChild(itemHTML);
        });
        
        totalPriceDisplay.textContent = formatRupiah(grandTotal);
        checkoutButton.disabled = !isCheckoutable;
        lucide.createIcons();
    }
    
    function changeItemQuantity(itemId, delta, event) {
        event.stopPropagation(); 
        let cartItems = getCartItems();
        // PERBAIKAN DI SINI: Membandingkan number dengan number
        const itemIndex = cartItems.findIndex(item => item.id === Number(itemId)); 
        // PERBAIKAN: Ambil data master produk untuk cek stok
        const masterProducts = JSON.parse(localStorage.getItem(DB_PRODUCTS_KEY)) || []; 

        if (itemIndex > -1) {
            const productInfo = masterProducts.find(p => p.id === cartItems[itemIndex].id);
            const availableStock = productInfo ? productInfo.stock : 0;
            const newQuantity = cartItems[itemIndex].quantity + delta;

            if (newQuantity > 0 && newQuantity <= availableStock) {
                cartItems[itemIndex].quantity = newQuantity;
                saveCartToLocalStorage(cartItems);
                renderCartPage();
            } else if (newQuantity > availableStock) {
                alert(`Stok maksimal untuk produk ini adalah ${availableStock}.`);
            } else {
                showDeleteConfirmModal(itemId);
            }
        }
    }

    // --- LOGIKA MODAL HAPUS ---
    let itemToDeleteId = null;
    const deleteModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');

    function showDeleteConfirmModal(itemId, event) {
        if(event) event.stopPropagation(); 
        itemToDeleteId = itemId;
        deleteModal.classList.remove('hidden');
    }

    function closeDeleteConfirmModal() {
        deleteModal.classList.add('hidden');
        itemToDeleteId = null;
    }

    confirmDeleteButton.addEventListener('click', () => {
        if (itemToDeleteId) {
            let cartItems = getCartItems();
            // PERBAIKAN DI SINI: Memfilter dengan mengubah string ID menjadi number
            cartItems = cartItems.filter(item => item.id !== Number(itemToDeleteId)); 
            saveCartToLocalStorage(cartItems);
            renderCartPage(); 
        }
        closeDeleteConfirmModal();
    });
    
    window.onload = renderCartPage;
</script>

</body>
</html>